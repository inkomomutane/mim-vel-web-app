services:
  php:
    image: ghcr.io/inkommutane/mimovel/website:latest
    environment:
      PHP_OPCACHE_ENABLE: "1"
      AUTORUN_ENABLED: "true" # ðŸ‘ˆ Remove this line if you don't want Laravel Automations
      HEALTHCHECK_PATH: "/up" # Use Laravel's built-in health route
      SSL_MODE: full
    networks:
      - web-public
    volumes:
      - "storage_private:/var/www/html/storage/app/private/"
      - "./storage/public:/var/www/html/storage/app/public/"
      - "storage_sessions:/var/www/html/storage/framework/sessions"
      - "storage_logs:/var/www/html/storage/logs"
      - "storage_svg:/var/www/html/storage/app/svg"
      - "./.env:/var/www/html/.env"
    deploy:
      replicas: 1
      update_config:
        failure_action: rollback
        parallelism: 1
        delay: 5s
        order: start-first
      rollback_config:
        parallelism: 1
        order: stop-first
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 3
        window: 120s
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.my-php-app.rule=Host(`mimovel.com`) || Host(`www.mimovel.com`) || Host(`web.mimovel.com`) || Host(`m.mimovel.com`)"
        - "traefik.http.routers.my-php-app.entrypoints=websecure"
        - "traefik.http.routers.my-php-app.tls=true"
        - "traefik.http.routers.my-php-app.tls.certresolver=le"
        - "traefik.http.services.my-php-app.loadbalancer.server.port=8443"
        - "traefik.http.services.my-php-app.loadbalancer.server.scheme=https"
        # Health check
        - "traefik.http.services.my-php-app.loadbalancer.healthcheck.path=/up"
        - "traefik.http.services.my-php-app.loadbalancer.healthcheck.interval=30s"
        - "traefik.http.services.my-php-app.loadbalancer.healthcheck.timeout=5s"
        - "traefik.http.services.my-php-app.loadbalancer.healthcheck.scheme=http"
  database:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - traefik_public
    deploy:
      replicas: 1
      update_config:
        failure_action: rollback
        parallelism: 1
        delay: 5s
        order: start-first
      rollback_config:
        parallelism: 1
        order: stop-first
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 3
        window: 120s
volumes:
  storage_private:
  storage_sessions:
  storage_logs:
  storage_svg:
  db_data:
networks:
  traefik_public:
     external: true
